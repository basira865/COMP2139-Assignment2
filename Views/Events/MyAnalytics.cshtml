@{
    ViewData["Title"] = "Analytics Dashboard";
}

<div class="container mt-4">
    <h2 class="mb-4">Event Analytics Dashboard</h2>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading analytics data...</p>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="alert alert-danger d-none" role="alert">
        <strong>Error:</strong> <span id="errorText"></span>
    </div>

    <!-- Charts Row -->
    <div id="chartsContainer" class="d-none">
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Ticket Sales by Category</h5>
                        <canvas id="categoryChart"></canvas>
                        <p id="noCategoryData" class="text-muted text-center mt-3 d-none">No sales data available</p>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Revenue per Month</h5>
                        <canvas id="revenueChart"></canvas>
                        <p id="noRevenueData" class="text-muted text-center mt-3 d-none">No revenue data available</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Events Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Top 5 Best-Selling Events</h5>
                        <div id="noEventsData" class="text-muted text-center my-3 d-none">
                            No event sales data available
                        </div>
                        <table id="eventsTable" class="table table-striped d-none">
                            <thead>
                            <tr>
                                <th>Event Title</th>
                                <th>Tickets Sold</th>
                                <th>Revenue</th>
                            </tr>
                            </thead>
                            <tbody id="topEventsTable">
                            <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Starting analytics data fetch...');
            console.log('Fetch URL:', window.location.origin + '/Events/GetAnalyticsData');

            // Fetch analytics data from API
            fetch('/Events/GetAnalyticsData')
                .then(response => {
                    console.log('Response received:', response);
                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text(); // Get as text first to see raw response
                })
                .then(text => {
                    console.log('Raw response text:', text);
                    return JSON.parse(text); // Then parse it
                })
                .then(data => {
                    console.log('Analytics data received:', data);

                    // Hide loading indicator
                    document.getElementById('loadingIndicator').classList.add('d-none');

                    // Show charts container
                    document.getElementById('chartsContainer').classList.remove('d-none');

                    // Check if we have any data
                    const hasData = (data.salesByCategory && data.salesByCategory.length > 0) ||
                        (data.revenueByMonth && data.revenueByMonth.length > 0) ||
                        (data.topEvents && data.topEvents.length > 0);

                    if (!hasData) {
                        console.warn('No data available in any category');
                    }

                    // Chart 1: Sales by Category
                    if (data.salesByCategory && data.salesByCategory.length > 0) {
                        const categoryCtx = document.getElementById('categoryChart').getContext('2d');
                        new Chart(categoryCtx, {
                            type: 'bar',
                            data: {
                                labels: data.salesByCategory.map(x => x.category),
                                datasets: [{
                                    label: 'Tickets Sold',
                                    data: data.salesByCategory.map(x => x.ticketsSold),
                                    backgroundColor: ['#007bff', '#28a745', '#dc3545', '#ffc107', '#17a2b8']
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            stepSize: 1
                                        }
                                    }
                                }
                            }
                        });
                        console.log('Category chart created');
                    } else {
                        document.getElementById('categoryChart').style.display = 'none';
                        document.getElementById('noCategoryData').classList.remove('d-none');
                        console.log('No category data available');
                    }

                    // Chart 2: Revenue per Month
                    if (data.revenueByMonth && data.revenueByMonth.length > 0) {
                        const revenueCtx = document.getElementById('revenueChart').getContext('2d');
                        new Chart(revenueCtx, {
                            type: 'line',
                            data: {
                                labels: data.revenueByMonth.map(x => x.month),
                                datasets: [{
                                    label: 'Revenue ($)',
                                    data: data.revenueByMonth.map(x => x.revenue),
                                    borderColor: '#007bff',
                                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 6,  // ADD THIS - makes points more visible
                                    pointHoverRadius: 8  // ADD THIS
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            callback: function(value) {
                                                return '$' + value.toFixed(2);
                                            }
                                        }
                                    }
                                },
                                plugins: {  // ADD THIS SECTION
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return 'Revenue: $' + context.parsed.y.toFixed(2);
                                            }
                                        }
                                    }
                                }
                            }
                        });
                        console.log('Revenue chart created');
                    } else {
                        document.getElementById('revenueChart').style.display = 'none';
                        document.getElementById('noRevenueData').classList.remove('d-none');
                        console.log('No revenue data available');
                    }

                    // Top 5 Events Table
                    if (data.topEvents && data.topEvents.length > 0) {
                        const tbody = document.getElementById('topEventsTable');
                        tbody.innerHTML = ''; // Clear existing content

                        data.topEvents.forEach(event => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${event.title || 'N/A'}</td>
                                <td>${event.ticketsSold || 0}</td>
                                <td>$${(event.revenue || 0).toFixed(2)}</td>
                            `;
                            tbody.appendChild(row);
                        });

                        document.getElementById('eventsTable').classList.remove('d-none');
                        console.log('Events table populated');
                    } else {
                        document.getElementById('noEventsData').classList.remove('d-none');
                        console.log('No top events data available');
                    }
                })
                .catch(error => {
                    console.error('Error loading analytics:', error);

                    // Hide loading indicator
                    document.getElementById('loadingIndicator').classList.add('d-none');

                    // Show error message
                    const errorDiv = document.getElementById('errorMessage');
                    const errorText = document.getElementById('errorText');
                    errorText.textContent = error.message || 'Failed to load analytics data';
                    errorDiv.classList.remove('d-none');
                });
        });
    </script>
}